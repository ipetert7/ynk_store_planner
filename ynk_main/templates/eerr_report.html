<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <title>EERR por tienda</title>
    {# El CSS se carga desde report_wrapper.html, no desde aquí #}
  </head>
  <body>
    <div class="container">
      <h1>Estado de Resultados por Tienda</h1>
      <p class="lead">
        Selecciona una tienda para revisar sus métricas mensuales y el punto de
        equilibrio estimado.
      </p>

      <div class="card selection-card">
        <h2>Selector de Banner / Sucursal</h2>
        <div class="selection-controls">
          <div class="selection-row">
            <label for="yearSelect">Año</label>
            <select id="yearSelect">
              <option value="">Selecciona un año…</option>
            </select>
          </div>
          <div class="selection-row">
            <label for="bannerSelect">Banner</label>
            <select id="bannerSelect">
              <option value="">Selecciona un banner…</option>
            </select>
          </div>
          <div class="selection-row">
            <label for="storeSelect">Sucursal</label>
            <select
              id="storeSelect"
              disabled
            >
              <option value="">Selecciona un banner primero…</option>
            </select>
          </div>
        </div>
      </div>

      <div
        id="storeDetails"
        class="card hidden"
      >
        <div class="header">
          <h2 id="storeTitle"></h2>
          <p
            class="helper"
            id="storeBanner"
          ></p>
        </div>
        <div class="scenario-legend">
          <span class="scenario-pill"><span class="swatch"></span>Real</span>
          <span class="scenario-pill is-budget"
            ><span class="swatch"></span>Presupuesto</span
          >
        </div>
        <div class="table-wrapper">
          <table
            id="eerrTable"
            class="eerr-table"
          >
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div
        id="rentFactsCard"
        class="card hidden"
      >
        <h3>Indicadores operacionales</h3>
        <div class="facts-title">Arriendos</div>
        <div class="facts-grid">
          <div class="fact-item">
            <span class="fact-label">Arriendo mínimo (UF)</span>
            <span
              id="factVmmUf"
              class="fact-value"
              >–</span
            >
          </div>
          <div class="fact-item">
            <span class="fact-label">Arriendo variable (%)</span>
            <span
              id="factPercent"
              class="fact-value"
              >–</span
            >
          </div>
          <div class="fact-item">
            <span class="fact-label">Fondo promoción (%)</span>
            <span
              id="factFondo"
              class="fact-value"
              >–</span
            >
          </div>
          <div class="fact-item">
            <span class="fact-label"
              >Venta para activar arriendo porcentual</span
            >
            <span
              id="factThreshold"
              class="fact-value"
              >–</span
            >
            <span
              id="factThresholdNote"
              class="fact-note hidden"
            ></span>
          </div>
        </div>
        <div class="facts-title">Dotación</div>
        <div class="facts-grid">
          <div class="fact-item">
            <span class="fact-label">Dotación actual</span>
            <span
              id="factDotacionTotal"
              class="fact-value"
              >–</span
            >
            <ul
              id="factDotacionDetalle"
              class="fact-detail-list hidden"
            ></ul>
          </div>
        </div>
      </div>

      <div
        id="resumenCard"
        class="card hidden"
      >
        <div class="header">
          <h2>EBITDA consolidado por mes</h2>
          <div class="ebitda-toggle">
            <label class="toggle-label">
              <input
                type="radio"
                name="ebitda-mode"
                value="currency"
                checked
              />
              <span>$ (pesos)</span>
            </label>
            <label class="toggle-label">
              <input
                type="radio"
                name="ebitda-mode"
                value="percent"
              />
              <span>% (porcentaje)</span>
            </label>
          </div>
        </div>
        <div class="table-wrapper">
          <table
            id="resumenTable"
            class="summary-table"
          >
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="page-footer">
        <div class="confidential-card">
          Confidencial · Uso exclusivo de Yáneken
        </div>
      </div>
    </div>

    <script>
      const metricConfig = __METRIC_CONFIG__;
      const storeData = __STORE_DATA__;
      const bannerMap = __BANNER_MAP__;
      const bannerSummary = __BANNER_SUMMARY__;
      const STAFF_ROLES = __STAFF_ROLES__;
      const SCENARIO_REAL = '__SCENARIO_REAL__';
      const SCENARIO_BUDGET = '__SCENARIO_BUDGET__';

      const yearSelect = document.getElementById('yearSelect');
      const bannerSelect = document.getElementById('bannerSelect');
      const storeSelect = document.getElementById('storeSelect');
      const storeDetails = document.getElementById('storeDetails');
      const resumenCard = document.getElementById('resumenCard');
      const storeTitle = document.getElementById('storeTitle');
      const storeBanner = document.getElementById('storeBanner');
      const eerrTableHead = document.querySelector('#eerrTable thead');
      const eerrTableBody = document.querySelector('#eerrTable tbody');
      const resumenHead = document.querySelector('#resumenTable thead');
      const resumenBody = document.querySelector('#resumenTable tbody');
      const rentFactsCard = document.getElementById('rentFactsCard');
      const factThresholdEl = document.getElementById('factThreshold');
      const factThresholdNoteEl = document.getElementById('factThresholdNote');
      const factVmmUfEl = document.getElementById('factVmmUf');
      const factPercentEl = document.getElementById('factPercent');
      const factFondoEl = document.getElementById('factFondo');
      const factDotacionTotalEl = document.getElementById('factDotacionTotal');
      const factDotacionDetalleEl = document.getElementById(
        'factDotacionDetalle'
      );

      const currencyFormatter = new Intl.NumberFormat('es-CL', {
        maximumFractionDigits: 0,
      });
      const percentFormatter = new Intl.NumberFormat('es-CL', {
        minimumFractionDigits: 1,
        maximumFractionDigits: 1,
      });
      const percentFormatterShort = new Intl.NumberFormat('es-CL', {
        minimumFractionDigits: 1,
        maximumFractionDigits: 1,
      });
      const ufFormatter = new Intl.NumberFormat('es-CL', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
      const staffFormatter = new Intl.NumberFormat('es-CL', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      });
      const MONTH_LABELS = [
        'Ene.',
        'Feb.',
        'Mar.',
        'Abr.',
        'May.',
        'Jun.',
        'Jul.',
        'Ago.',
        'Sep.',
        'Oct.',
        'Nov.',
        'Dic.',
      ];

      function formatMonthLabel(isoValue) {
        if (!isoValue) {
          return '';
        }
        const date = new Date(`${isoValue}T00:00:00Z`);
        const month = date.getUTCMonth();
        const year = String(date.getUTCFullYear()).slice(-2);
        return `${MONTH_LABELS[month]} ${year}`;
      }

      function getEbitdaColorClass(value) {
        if (value === null || value === undefined || Number.isNaN(value)) {
          return '';
        }
        if (value < 0) {
          return 'ebitda-negative';
        } else if (value <= 5) {
          return 'ebitda-low';
        } else {
          return 'ebitda-high';
        }
      }
      let currentStoreKey = '';
      let currentEbitdaMode = 'currency'; // 'currency' o 'percent'

      function getAvailableYears() {
        const yearsSet = new Set();
        const yearsWithRealData = new Set();

        // Recolectar años de storeData
        for (const storeKey in storeData) {
          const store = storeData[storeKey];
          if (store && store.months) {
            const monthTypes = store.month_types || {};
            for (const month of store.months) {
              const year = month.split('-')[0];
              yearsSet.add(year);
              if (monthTypes[month] === SCENARIO_REAL) {
                yearsWithRealData.add(year);
              }
            }
          }
        }

        // Recolectar años de bannerSummary
        for (const bannerKey in bannerSummary) {
          const summary = bannerSummary[bannerKey];
          if (summary && summary.months) {
            const monthTypes = summary.month_types || {};
            for (const month of summary.months) {
              const year = month.split('-')[0];
              yearsSet.add(year);
              if (monthTypes[month] === SCENARIO_REAL) {
                yearsWithRealData.add(year);
              }
            }
          }
        }

        return {
          allYears: Array.from(yearsSet).sort(
            (a, b) => parseInt(a) - parseInt(b)
          ),
          yearsWithRealData: Array.from(yearsWithRealData).sort(
            (a, b) => parseInt(a) - parseInt(b)
          ),
        };
      }

      function getLatestYearWithRealData() {
        const { yearsWithRealData } = getAvailableYears();
        return yearsWithRealData.length > 0
          ? yearsWithRealData[yearsWithRealData.length - 1]
          : null;
      }

      function filterMonthsByYear(months, year) {
        if (!year || !months) {
          return months || [];
        }
        return months.filter((month) => month.startsWith(year + '-'));
      }

      function populateSelectors() {
        // Poblar selector de año
        const { allYears } = getAvailableYears();
        const latestYearWithRealData = getLatestYearWithRealData();
        yearSelect.innerHTML = '';
        const yearPlaceholder = document.createElement('option');
        yearPlaceholder.value = '';
        yearPlaceholder.textContent = 'Selecciona un año…';
        yearSelect.appendChild(yearPlaceholder);
        for (const year of allYears) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        }
        // No establecer año por defecto
        // if (latestYearWithRealData) {
        //     yearSelect.value = latestYearWithRealData;
        // }

        // Poblar selector de banner
        const banners = Object.keys(bannerMap).sort((a, b) =>
          a.localeCompare(b)
        );
        const existing = new Set(
          Array.from(bannerSelect.options).map((opt) => opt.value)
        );
        for (const banner of banners) {
          if (!banner) {
            continue;
          }
          if (existing.has(banner)) {
            continue;
          }
          const option = document.createElement('option');
          option.value = banner;
          option.textContent = banner;
          bannerSelect.appendChild(option);
        }
        bannerSelect.value = '';
        storeSelect.innerHTML = '';
        const storePlaceholder = document.createElement('option');
        storePlaceholder.value = '';
        storePlaceholder.textContent = 'Selecciona un banner primero…';
        storeSelect.appendChild(storePlaceholder);
        storeSelect.disabled = true;
        storeDetails.classList.add('hidden');
        rentFactsCard.classList.add('hidden');
      }

      function formatValue(value, formato) {
        if (value === null || value === undefined) {
          return '–';
        }
        if (formato === 'percent') {
          return percentFormatter.format(value) + '%';
        }
        return currencyFormatter.format(value);
      }

      function computeAnnualAggregate(valoresPorMes, meses, formato) {
        if (!valoresPorMes || !Array.isArray(meses)) {
          return null;
        }
        let total = 0;
        let count = 0;
        let hasValue = false;
        for (const mes of meses) {
          const valor = valoresPorMes[mes];
          if (typeof valor !== 'number' || Number.isNaN(valor)) {
            continue;
          }
          if (formato === 'percent') {
            total += valor;
            count += 1;
          } else {
            total += valor;
            hasValue = true;
          }
        }
        if (formato === 'percent') {
          return count > 0 ? total / count : null;
        }
        return hasValue ? total : null;
      }

      function renderEerrTable(ficha) {
        const selectedYear = yearSelect.value;
        let meses = ficha.months;
        const monthTypes = ficha.month_types || {};

        // Filtrar meses por año seleccionado
        meses = filterMonthsByYear(meses, selectedYear);

        eerrTableHead.innerHTML = '';
        eerrTableBody.innerHTML = '';

        if (!meses || meses.length === 0) {
          return;
        }

        const headerRow = document.createElement('tr');
        const cuentaTh = document.createElement('th');
        cuentaTh.textContent = 'Cuenta';
        headerRow.appendChild(cuentaTh);
        for (const mes of meses) {
          const th = document.createElement('th');
          th.textContent = formatMonthLabel(mes);
          const scenario = monthTypes[mes] || SCENARIO_REAL;
          th.dataset.scenario = scenario;
          if (scenario === SCENARIO_BUDGET) {
            th.classList.add('is-budget');
          }
          headerRow.appendChild(th);
        }
        const totalTh = document.createElement('th');
        totalTh.textContent = 'Total año';
        headerRow.appendChild(totalTh);
        eerrTableHead.appendChild(headerRow);

        const subMetrics = new Set([
          'Arriendo_fijo',
          'Arriendo_variable',
          'Arriendo_fondo_promocion',
          'Arriendo_GGCC',
          'Remuneraciones_fijo',
          'Remuneraciones_comisiones',
        ]);

        for (const config of metricConfig) {
          const row = document.createElement('tr');
          if (subMetrics.has(config.id)) {
            row.classList.add('sub-row');
          }
          const header = document.createElement('th');
          header.textContent = config.label;
          row.appendChild(header);
          const almacen = ficha.values[config.id] || {};
          for (const mes of meses) {
            const cell = document.createElement('td');
            cell.dataset.metric = config.id;
            cell.textContent = formatValue(almacen[mes], config.format);
            const scenario = monthTypes[mes] || SCENARIO_REAL;
            if (scenario === SCENARIO_BUDGET) {
              cell.classList.add('is-budget');
            }
            row.appendChild(cell);
          }
          const totalCell = document.createElement('td');
          totalCell.classList.add('total-cell');
          totalCell.dataset.metric = config.id;
          const total = computeAnnualAggregate(almacen, meses, config.format);
          totalCell.textContent = formatValue(total, config.format);
          row.appendChild(totalCell);
          eerrTableBody.appendChild(row);
        }
      }

      function renderRentFacts(ficha) {
        const detalles = ficha.rent_details || {};
        const thresholdBase = detalles.threshold_clp;
        let thresholdPeak = detalles.threshold_peak_clp;
        const peakFactor = detalles.peak_factor;
        const vmmUf = detalles.vmm_uf;
        const porcentaje = detalles.percent;
        const fondoPromocion = detalles.fondo_promocion;
        const dotacionTotal = detalles.dotacion_total;
        const dotacionDetalle = detalles.dotacion_detalle || {};
        const thresholdsByMonth = detalles.thresholds_by_month || {};
        const defaultMonthKey = detalles.default_month || null;

        const tieneInfo =
          (Number.isFinite(thresholdBase) && thresholdBase > 0) ||
          Object.values(thresholdsByMonth).some(
            (valor) => Number.isFinite(valor) && valor > 0
          ) ||
          (Number.isFinite(vmmUf) && vmmUf > 0) ||
          (Number.isFinite(porcentaje) && porcentaje > 0) ||
          (Number.isFinite(fondoPromocion) && fondoPromocion > 0) ||
          (Number.isFinite(dotacionTotal) && dotacionTotal > 0) ||
          Object.keys(dotacionDetalle).length > 0;

        if (!tieneInfo) {
          rentFactsCard.classList.add('hidden');
          factThresholdEl.textContent = '–';
          if (factThresholdNoteEl) {
            factThresholdNoteEl.textContent = '';
            factThresholdNoteEl.classList.add('hidden');
          }
          factVmmUfEl.textContent = '–';
          factPercentEl.textContent = '–';
          factFondoEl.textContent = '–';
          factDotacionTotalEl.textContent = '–';
          factDotacionDetalleEl.innerHTML = '';
          return;
        }

        let thresholdToShow = thresholdBase;
        if (!Number.isFinite(thresholdToShow) || thresholdToShow <= 0) {
          if (
            defaultMonthKey &&
            Number.isFinite(thresholdsByMonth[defaultMonthKey])
          ) {
            thresholdToShow = thresholdsByMonth[defaultMonthKey];
          } else {
            const firstValidThreshold = Object.values(thresholdsByMonth).find(
              (valor) => Number.isFinite(valor) && valor > 0
            );
            if (firstValidThreshold !== undefined) {
              thresholdToShow = firstValidThreshold;
            }
          }
        }

        if (Number.isFinite(thresholdToShow) && thresholdToShow > 0) {
          factThresholdEl.textContent =
            currencyFormatter.format(thresholdToShow);
        } else {
          factThresholdEl.textContent = '–';
        }

        if (
          (!Number.isFinite(thresholdPeak) || thresholdPeak <= 0) &&
          Number.isFinite(peakFactor) &&
          peakFactor > 1
        ) {
          const picoDesdeMes = Object.entries(thresholdsByMonth).find(
            ([mes, valor]) => {
              const esValido = Number.isFinite(valor) && valor > 0;
              return esValido && mes.endsWith('-12');
            }
          );
          if (
            picoDesdeMes &&
            Number.isFinite(picoDesdeMes[1]) &&
            picoDesdeMes[1] > 0
          ) {
            thresholdPeak = picoDesdeMes[1];
          }
        }

        const factorTienePico =
          Number.isFinite(thresholdPeak) &&
          thresholdPeak > 0 &&
          Number.isFinite(peakFactor) &&
          peakFactor > 1;

        if (factorTienePico && factThresholdNoteEl) {
          const factorFormatted =
            peakFactor % 1 === 0
              ? peakFactor.toFixed(0)
              : peakFactor
                  .toFixed(2)
                  .replace(/\.0+$/, '')
                  .replace(/(\.\d*?)0+$/, '$1');
          factThresholdNoteEl.textContent = `En diciembre el factor ${factorFormatted}× eleva la venta requerida a ${currencyFormatter.format(
            thresholdPeak
          )}.`;
          factThresholdNoteEl.classList.remove('hidden');
        } else if (factThresholdNoteEl) {
          factThresholdNoteEl.textContent = '';
          factThresholdNoteEl.classList.add('hidden');
        }

        if (Number.isFinite(vmmUf) && vmmUf > 0) {
          factVmmUfEl.textContent = ufFormatter.format(vmmUf);
        } else {
          factVmmUfEl.textContent = '–';
        }

        if (Number.isFinite(porcentaje) && porcentaje > 0) {
          factPercentEl.textContent =
            percentFormatterShort.format(porcentaje * 100) + '%';
        } else {
          factPercentEl.textContent = '–';
        }

        if (Number.isFinite(fondoPromocion) && fondoPromocion > 0) {
          factFondoEl.textContent =
            percentFormatterShort.format(fondoPromocion * 100) + '%';
        } else {
          factFondoEl.textContent = '–';
        }

        if (Number.isFinite(dotacionTotal) && dotacionTotal >= 0) {
          factDotacionTotalEl.textContent =
            staffFormatter.format(dotacionTotal);
        } else {
          factDotacionTotalEl.textContent = '–';
        }

        const rolesList =
          Array.isArray(STAFF_ROLES) && STAFF_ROLES.length > 0
            ? STAFF_ROLES
            : Object.keys(dotacionDetalle || {}).sort((a, b) =>
                a.localeCompare(b)
              );
        const entries = rolesList.map((rol) => {
          const valor = Number(dotacionDetalle[rol] || 0);
          return [rol, valor];
        });
        factDotacionDetalleEl.innerHTML = '';
        if (entries.length > 0) {
          for (const [rol, cantidad] of entries) {
            const item = document.createElement('li');
            item.classList.add('fact-detail-item');
            if (!Number.isFinite(cantidad) || cantidad <= 0) {
              item.classList.add('is-empty');
            }

            const rolSpan = document.createElement('span');
            rolSpan.classList.add('fact-detail-role');
            rolSpan.textContent = rol;

            const cantidadSpan = document.createElement('span');
            cantidadSpan.classList.add('fact-detail-count');
            cantidadSpan.textContent = staffFormatter.format(
              Math.max(cantidad, 0)
            );

            item.appendChild(rolSpan);
            item.appendChild(cantidadSpan);
            factDotacionDetalleEl.appendChild(item);
          }
          factDotacionDetalleEl.classList.remove('hidden');
        } else {
          factDotacionDetalleEl.classList.add('hidden');
        }

        rentFactsCard.classList.remove('hidden');
      }

      function renderResumen(bannerKey) {
        resumenHead.innerHTML = '';
        resumenBody.innerHTML = '';

        if (!bannerKey || !bannerSummary[bannerKey]) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 2;
          cell.textContent =
            'Selecciona un banner para revisar el EBITDA por tienda.';
          row.appendChild(cell);
          resumenBody.appendChild(row);
          return;
        }

        const selectedYear = yearSelect.value;
        const info = bannerSummary[bannerKey];
        let months = info.months;
        const monthTypes = info.month_types || {};
        const stores = Object.keys(info.stores || {}).sort((a, b) =>
          a.localeCompare(b)
        );

        // Filtrar meses por año seleccionado
        months = filterMonthsByYear(months, selectedYear);

        // Determinar qué métrica usar según el modo
        const usePercent = currentEbitdaMode === 'percent';

        const headerRow = document.createElement('tr');
        const thStore = document.createElement('th');
        thStore.textContent = 'Tienda';
        headerRow.appendChild(thStore);
        months.forEach((mes) => {
          const th = document.createElement('th');
          th.textContent = formatMonthLabel(mes);
          const scenario = monthTypes[mes] || SCENARIO_REAL;
          th.dataset.scenario = scenario;
          if (scenario === SCENARIO_BUDGET) {
            th.classList.add('is-budget');
          }
          headerRow.appendChild(th);
        });
        const thTotal = document.createElement('th');
        thTotal.textContent = usePercent ? 'Promedio EBITDA %' : 'Total EBITDA';
        headerRow.appendChild(thTotal);
        resumenHead.appendChild(headerRow);

        const totalsByMonth = months.map(() => 0);
        const countsByMonth = months.map(() => 0);
        let totalBanner = 0;
        let countBanner = 0;

        for (const store of stores) {
          const row = document.createElement('tr');
          const cellStore = document.createElement('th');
          cellStore.textContent = store;
          row.appendChild(cellStore);

          let totalTienda = 0;
          let countTienda = 0;
          months.forEach((mes, idx) => {
            let valor;
            if (usePercent) {
              // Obtener Margen_EBITDA de storeData
              const storeInfo = storeData[store];
              if (
                storeInfo &&
                storeInfo.values &&
                storeInfo.values.Margen_EBITDA
              ) {
                valor = storeInfo.values.Margen_EBITDA[mes];
              } else {
                valor = null;
              }
            } else {
              // Usar EBITDA en pesos de info.stores
              valor = info.stores[store][mes] ?? 0;
            }

            const cell = document.createElement('td');
            if (usePercent) {
              if (
                valor !== null &&
                valor !== undefined &&
                !Number.isNaN(valor)
              ) {
                const span = document.createElement('span');
                span.textContent = percentFormatter.format(valor) + '%';
                span.className = getEbitdaColorClass(valor);
                cell.appendChild(span);
                totalTienda += valor;
                countTienda++;
                totalsByMonth[idx] += valor;
                countsByMonth[idx]++;
              } else {
                cell.textContent = '–';
              }
            } else {
              cell.textContent = currencyFormatter.format(valor);
              totalTienda += valor;
              totalsByMonth[idx] += valor;
            }

            const scenario = monthTypes[mes] || SCENARIO_REAL;
            if (scenario === SCENARIO_BUDGET) {
              cell.classList.add('is-budget');
            }
            row.appendChild(cell);
          });

          const totalCell = document.createElement('td');
          if (usePercent) {
            if (countTienda > 0) {
              const promedio = totalTienda / countTienda;
              const span = document.createElement('span');
              span.textContent = percentFormatter.format(promedio) + '%';
              span.className = getEbitdaColorClass(promedio);
              totalCell.appendChild(span);
              totalBanner += totalTienda;
              countBanner += countTienda;
            } else {
              totalCell.textContent = '–';
            }
          } else {
            totalCell.textContent = currencyFormatter.format(totalTienda);
            totalBanner += totalTienda;
          }
          totalCell.classList.add('total-cell');
          row.appendChild(totalCell);
          resumenBody.appendChild(row);
        }

        if (stores.length > 0) {
          const totalRow = document.createElement('tr');
          totalRow.classList.add('total-row');
          const totalLabel = document.createElement('th');
          totalLabel.textContent = 'Total banner';
          totalRow.appendChild(totalLabel);
          months.forEach((_, idx) => {
            const cell = document.createElement('td');
            if (usePercent) {
              if (countsByMonth[idx] > 0) {
                const promedio = totalsByMonth[idx] / countsByMonth[idx];
                const span = document.createElement('span');
                span.textContent = percentFormatter.format(promedio) + '%';
                span.className = getEbitdaColorClass(promedio);
                cell.appendChild(span);
              } else {
                cell.textContent = '–';
              }
            } else {
              cell.textContent = currencyFormatter.format(totalsByMonth[idx]);
            }
            cell.classList.add('total-cell');
            const mes = months[idx];
            const scenario = monthTypes[mes] || SCENARIO_REAL;
            if (scenario === SCENARIO_BUDGET) {
              cell.classList.add('is-budget');
            }
            totalRow.appendChild(cell);
          });
          const totalBannerCell = document.createElement('td');
          if (usePercent) {
            if (countBanner > 0) {
              const promedio = totalBanner / countBanner;
              const span = document.createElement('span');
              span.textContent = percentFormatter.format(promedio) + '%';
              span.className = getEbitdaColorClass(promedio);
              totalBannerCell.appendChild(span);
            } else {
              totalBannerCell.textContent = '–';
            }
          } else {
            totalBannerCell.textContent = currencyFormatter.format(totalBanner);
          }
          totalBannerCell.classList.add('total-cell');
          totalRow.appendChild(totalBannerCell);
          resumenBody.appendChild(totalRow);
        } else {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = Math.max(2, months.length + 2);
          cell.textContent = 'Sin tiendas asociadas al banner seleccionado.';
          row.appendChild(cell);
          resumenBody.appendChild(row);
        }
      }

      function handleBannerChange() {
        const bannerSeleccionado = bannerSelect.value;
        currentStoreKey = '';

        storeSelect.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = bannerSeleccionado
          ? 'Selecciona una sucursal…'
          : 'Selecciona un banner primero…';
        storeSelect.appendChild(placeholder);

        if (!bannerSeleccionado || !bannerMap[bannerSeleccionado]) {
          storeSelect.disabled = true;
          storeSelect.setAttribute('disabled', 'disabled');
          storeDetails.classList.add('hidden');
          rentFactsCard.classList.add('hidden');
          resumenCard.classList.add('hidden');
          renderResumen(null);
          return;
        }

        storeSelect.disabled = false;
        storeSelect.removeAttribute('disabled');
        const tiendas = bannerMap[bannerSeleccionado];
        for (const tienda of tiendas) {
          const option = document.createElement('option');
          option.value = tienda;
          option.textContent = tienda;
          storeSelect.appendChild(option);
        }

        storeDetails.classList.add('hidden');
        rentFactsCard.classList.add('hidden');
        renderResumen(bannerSeleccionado);
        resumenCard.classList.remove('hidden');
      }

      function updateStoreDetails() {
        const bannerSeleccionado = bannerSelect.value;
        const seleccionado = storeSelect.value;
        if (!bannerSeleccionado) {
          storeDetails.classList.add('hidden');
          rentFactsCard.classList.add('hidden');
          resumenCard.classList.add('hidden');
          currentStoreKey = '';
          return;
        }

        const tiendasDisponibles = bannerMap[bannerSeleccionado] || [];
        if (!seleccionado || !tiendasDisponibles.includes(seleccionado)) {
          storeDetails.classList.add('hidden');
          rentFactsCard.classList.add('hidden');
          currentStoreKey = '';
          return;
        }

        const ficha = storeData[seleccionado];
        if (!ficha) {
          storeDetails.classList.add('hidden');
          rentFactsCard.classList.add('hidden');
          currentStoreKey = '';
          return;
        }

        currentStoreKey = seleccionado;
        storeTitle.textContent = seleccionado;
        if (ficha.banner) {
          storeBanner.innerHTML =
            'Banner: <span class="badge">' + ficha.banner + '</span>';
        } else {
          storeBanner.textContent = '';
        }

        renderEerrTable(ficha);
        renderRentFacts(ficha);
        storeDetails.classList.remove('hidden');
        resumenCard.classList.remove('hidden');
        // rentFactsCard visibility handled in renderRentFacts
      }

      // const widthSelect = document.getElementById('widthSelect'); // No existe
      // Aplicar ancho de contenedor por defecto (función no definida)
      // applyContainerWidth(DEFAULT_CONTAINER_WIDTH);

      function handleYearChange() {
        const selectedYear = yearSelect.value;
        const bannerSeleccionado = bannerSelect.value;
        const storeSeleccionado = storeSelect.value;

        if (storeSeleccionado && currentStoreKey) {
          const ficha = storeData[currentStoreKey];
          if (ficha) {
            renderEerrTable(ficha);
          }
        }

        // Si hay un banner seleccionado, actualizar el resumen
        if (bannerSeleccionado) {
          renderResumen(bannerSeleccionado);
        } else {
          renderResumen(null);
        }
      }

      // Inicializar página
      populateSelectors();
      renderResumen(null);
      yearSelect.addEventListener('change', handleYearChange);
      bannerSelect.addEventListener('change', handleBannerChange);
      storeSelect.addEventListener('change', updateStoreDetails);

      // Event listeners para el toggle de EBITDA
      const ebitdaModeRadios = document.querySelectorAll(
        'input[name="ebitda-mode"]'
      );
      ebitdaModeRadios.forEach((radio) => {
        radio.addEventListener('change', (event) => {
          currentEbitdaMode = event.target.value;
          const bannerSeleccionado = bannerSelect.value;
          if (bannerSeleccionado) {
            renderResumen(bannerSeleccionado);
          }
        });
      });
    </script>
  </body>
</html>
